INSERT INTO INVENTORY_STORE_BOP_METADATA(
BRAND_ID, STAGE_TABLE_NAME, BASE_TABLE_NAME, EDW_TO_BASE_QUERY, EDW_TO_STAGE_QUERY, STAGE_TO_BASE_QUERY, DB)
VALUES(5, 'stage.INVENTORY_STORE_BOP', 'base.INVENTORY_STORE_BOP',
'select BRAND, MARKET,CHANNEL,CC_ID
,FISCAL_YEAR
,FISCAL_WEEK
,sum(STORE_BOP_QUANTITY) AS STORE_BOP_QUANTITY
,sum(STORE_COUNT_INVENTORY) AS STORE_COUNT_INVENTORY
FROM
(
select  BRD.OPR_BRD_ID AS BRAND
,TMKTL.MKT_CD AS MARKET
,TCHNL.CHNL_CD AS CHANNEL 
,TUHFD.OPR_GLBL_STY_CLR_ID AS CC_ID
,VLDEA.FIS_YR_NBR AS FISCAL_YEAR
,VLDEA.FIS_WK_NBR AS FISCAL_WEEK
,SUM(VLDEA.IXIT_INV_UN_QTY +VLDEA.OH_INV_UN_QTY )
AS STORE_BOP_QUANTITY 
,CASE WHEN  SUM(VLDEA.IXIT_INV_UN_QTY +VLDEA.OH_INV_UN_QTY ) > 0
 THEN
 count(distinct VLDEA.LOC_KEY) end as STORE_COUNT_INVENTORY
 
FROM VIEWSLS.VLDEA_LOC_CC_DAY_EOP_INV_AGG VLDEA
 
INNER JOIN (SELECT min(TIEDL.WK_END_DT) PROC_DT
FROM VIEWSLS.TIEDL_INV_EOP_DT_LOOKUP TIEDL
WHERE TIEDL.WK_END_DT BETWEEN (SELECT WK_END_DT - 455
FROM VIEWFNDT.TFCFD_FIS_CAL_FLATTENED_DIM TFCFD
WHERE FIS_CAL_DT = CURRENT_DATE
GROUP BY 1)
AND (SELECT WK_STRT_DT-1
FROM VIEWFNDT.TFCFD_FIS_CAL_FLATTENED_DIM TFCFD
WHERE FIS_CAL_DT = CURRENT_DATE
GROUP BY 1)
GROUP BY TIEDL.FIS_WK_NBR,
TIEDL.FIS_YR_NBR) SLSDT
ON VLDEA.PROC_DT = SLSDT.PROC_DT
 
INNER JOIN VIEWFNDT.TUHFD_UNIV_HIER_FLAT_DIM TUHFD
ON VLDEA.BRD_STY_CLR_KEY=TUHFD.BRD_STY_CLR_KEY
 
 
INNER JOIN VIEWFNDT.TLOCD_LOC_DIM TLOCD
ON  VLDEA.LOC_KEY=TLOCD.LOC_KEY
AND TLOCD.CUR_REC_IND=''Y''
 
INNER JOIN (SELECT  BCR_BRD_KEY,OPR_BRD_ID
FROM VIEWXREF.TMCDX_MH_CO_DIV_XREF
GROUP BY 1,2) BRD
ON BRD.BCR_BRD_KEY = TUHFD.PAR_BRD_KEY
 
 
INNER JOIN VIEWFNDT.TMKTL_MKT_LOOKUP TMKTL
ON TMKTL.MKT_KEY = VLDEA.MKT_KEY
 
INNER JOIN VIEWFNDT.TCHNL_CHNL_LOOKUP TCHNL
ON TCHNL.CHNL_KEY = VLDEA.DD_CHNL_KEY
 
WHERE VLDEA.DD_CHNL_KEY IN (1)
AND TUHFD.PAR_BRD_KEY IN (5)
AND TLOCD.ENTR_LOC_TYP_CD_ID not IN (48,49,1610)
 
group by
BRD.OPR_BRD_ID
,TMKTL.MKT_CD
,TCHNL.CHNL_CD
,TUHFD.OPR_GLBL_STY_CLR_ID
,VLDEA.DD_CHNL_KEY
,VLDEA.FIS_YR_NBR
,VLDEA.FIS_WK_NBR
,IXIT_INV_UN_QTY
,OH_INV_UN_QTY
,NON_SELL_UN_QTY
,RSV_UN_QTY
 
)
AA
group by
BRAND, MARKET,CHANNEL,CC_ID
,FISCAL_YEAR
,FISCAL_WEEK',
'select BRAND, MARKET,CHANNEL,CC_ID
,FISCAL_YEAR
,FISCAL_WEEK
,sum(STORE_BOP_QUANTITY) AS STORE_BOP_QUANTITY
,sum(STORE_COUNT_INVENTORY) AS STORE_COUNT_INVENTORY
FROM
(
select  BRD.OPR_BRD_ID AS BRAND
,TMKTL.MKT_CD AS MARKET
,TCHNL.CHNL_CD AS CHANNEL 
,TUHFD.OPR_GLBL_STY_CLR_ID AS CC_ID
,VLDEA.FIS_YR_NBR AS FISCAL_YEAR
,VLDEA.FIS_WK_NBR AS FISCAL_WEEK
,SUM(VLDEA.IXIT_INV_UN_QTY +VLDEA.OH_INV_UN_QTY )
AS STORE_BOP_QUANTITY 
,CASE WHEN  SUM(VLDEA.IXIT_INV_UN_QTY +VLDEA.OH_INV_UN_QTY ) > 0
 THEN
 count(distinct VLDEA.LOC_KEY) end as STORE_COUNT_INVENTORY
 
FROM VIEWSLS.VLDEA_LOC_CC_DAY_EOP_INV_AGG VLDEA
 
INNER JOIN (SELECT min(TIEDL.WK_END_DT) PROC_DT
FROM VIEWSLS.TIEDL_INV_EOP_DT_LOOKUP TIEDL
WHERE TIEDL.WK_END_DT BETWEEN (SELECT WK_END_DT - 49
FROM VIEWFNDT.TFCFD_FIS_CAL_FLATTENED_DIM TFCFD
WHERE FIS_CAL_DT = CURRENT_DATE
GROUP BY 1)
AND (SELECT WK_STRT_DT-1
FROM VIEWFNDT.TFCFD_FIS_CAL_FLATTENED_DIM TFCFD
WHERE FIS_CAL_DT = CURRENT_DATE
GROUP BY 1)
GROUP BY TIEDL.FIS_WK_NBR,
TIEDL.FIS_YR_NBR) SLSDT
ON VLDEA.PROC_DT = SLSDT.PROC_DT
 
INNER JOIN VIEWFNDT.TUHFD_UNIV_HIER_FLAT_DIM TUHFD
ON VLDEA.BRD_STY_CLR_KEY=TUHFD.BRD_STY_CLR_KEY
 
 
INNER JOIN VIEWFNDT.TLOCD_LOC_DIM TLOCD
ON  VLDEA.LOC_KEY=TLOCD.LOC_KEY
AND TLOCD.CUR_REC_IND=''Y''
 
INNER JOIN (SELECT  BCR_BRD_KEY,OPR_BRD_ID
FROM VIEWXREF.TMCDX_MH_CO_DIV_XREF
GROUP BY 1,2) BRD
ON BRD.BCR_BRD_KEY = TUHFD.PAR_BRD_KEY
 
 
INNER JOIN VIEWFNDT.TMKTL_MKT_LOOKUP TMKTL
ON TMKTL.MKT_KEY = VLDEA.MKT_KEY
 
INNER JOIN VIEWFNDT.TCHNL_CHNL_LOOKUP TCHNL
ON TCHNL.CHNL_KEY = VLDEA.DD_CHNL_KEY
 
WHERE VLDEA.DD_CHNL_KEY IN (1)
AND TUHFD.PAR_BRD_KEY IN (5)
AND TLOCD.ENTR_LOC_TYP_CD_ID not IN (48,49,1610)
 
group by
BRD.OPR_BRD_ID
,TMKTL.MKT_CD
,TCHNL.CHNL_CD
,TUHFD.OPR_GLBL_STY_CLR_ID
,VLDEA.DD_CHNL_KEY
,VLDEA.FIS_YR_NBR
,VLDEA.FIS_WK_NBR
,IXIT_INV_UN_QTY
,OH_INV_UN_QTY
,NON_SELL_UN_QTY
,RSV_UN_QTY
 
)
AA
group by
BRAND, MARKET,CHANNEL,CC_ID
,FISCAL_YEAR
,FISCAL_WEEK',
'DELETE FROM base.INVENTORY_STORE_BOP
WHERE (FISCAL_YEAR =
(SELECT MIN(FISCAL_YEAR) FROM stage.INVENTORY_STORE_BOP)
AND
FISCAL_WEEK >=
(SELECT MIN(FISCAL_WEEK) FROM  stage.INVENTORY_STORE_BOP
WHERE FISCAL_YEAR = (SELECT MIN(FISCAL_YEAR) FROM stage.INVENTORY_STORE_BOP)))
OR
(FISCAL_YEAR > (SELECT MIN(FISCAL_YEAR) FROM stage.INVENTORY_STORE_BOP))
OR
(FISCAL_year = (SELECT MIN(FISCAL_YEAR) FROM base.INVENTORY_STORE_BOP)
AND
FISCAL_WEEK=
(SELECT MIN(FISCAL_WEEK) FROM base.INVENTORY_STORE_BOP
WHERE FISCAL_YEAR = (SELECT MIN(FISCAL_YEAR) FROM base.INVENTORY_STORE_BOP))
AND
(select count(distinct convert(varchar,fiscal_Week)+convert(varchar,Fiscal_year))
FROM base.INVENTORY_STORE_BOP > 64)',
'ads_db_brfs');